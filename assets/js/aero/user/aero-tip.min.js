"use strict";Aero.tip={tries:0,options:{labels:{end:AeroStep.lang.finished,next:AeroStep.lang.next,prev:AeroStep.lang.prev},template:function(e){var t="",o="",r="",i="",s=e.position?e.position:"top",a=parseInt(Aero.tip._current)+1,n=Aero.tip._guide?Aero.tip._guide.step.length:0;t=isNaN(e.size)?e.size&&""!=e.size?" aero-tip-"+e.size:"":"' style='width:"+e.size+"px'";var p=["OVERVIEW","CLICK","CHOOSE","COPY","DRAG","FORK","NOTE","TIP","TYPE","SCROLL"],l='<img class="as-icon-TITLE" src="'+Aero.constants.PATH+'assets/images/icons/TITLE.png" title="TITLE" />';for(var c in p)if("string"==typeof p[c]){o="OVERVIEW"==p[c]?"Overview":"";e.title=e.title.replace(p[c],l.replace(/TITLE/g,p[c].toLowerCase())+" "+o)}e.showTitle&&(o='<div class="aero-tip-title">'+e.title+'<span></span><a title="Close Guide">&#10005;</a></div>');var f=e.multi?"":"<div class='aero-tip-nav clearfix'><div class='aero-progress'><span>Step "+a+" of "+n+"</span></div></div>";Aero.tip._guide||(f=""),e.answers&&e.answers.length>0&&(r=Aero.view.quiz.render(e.answers,e.quizsize)),(e.embed||e.youtube)&&(i=Aero.view.media.render(e));var d="Enterprise"==AeroStep.license?"":'<div class="aero-lic">Powered by <a href="http://www.jumpseat.io" target="_blank">JumpSeat</a></div>';return"<div id='"+e.id+"' class='aero-tip aero-tip-"+s+t+"' style='display:none'><div class='aero-tip-arrow'></div><div class='aero-tip-body'>"+o+e.body+r+i+"</div>"+f+d+"<div class='aero-tip-draggable'></div></div>"}},spotlight:function(e,t){var o,r,i,s;o=$q(t.loc);var a=1/(r={height:window.innerHeight,width:window.innerWidth}).height,n=1/r.width;(s=o.offset()).tl={top:a*s.top,left:n*s.left},s.tr={top:a*s.top,left:n*(s.left+o.innerWidth())},s.br={top:a*(s.top+o.innerHeight()),left:n*(s.left+o.innerWidth())},s.bl={top:a*(s.top+o.innerHeight()),left:n*s.left},i='<svg width="0" height="0" class="aero-remove"><defs><clipPath id="clipArea" clipPathUnits="objectBoundingBox">',i+='<path d="M0,0 L1,0 L1,1 L0,1 L'+s.bl.left+","+s.bl.top+" L"+s.br.left+","+s.br.top+" L"+s.tr.left+","+s.tr.top+" L"+s.tl.left+","+s.tl.top+"  L"+s.bl.left+","+s.bl.top+' L0,1" />',i+="</clipPath></defs></svg>",$q("body").append(i),$q("body").append('<div class="aero-remove aero-overlay"></div>')},setGuide:function(e,t,o){var r=this;r._guide=!1,aeroStorage.getItem("aero:session",function(i){i&&!o?(r._guide=JSON.parse(i),Aero.view.step.render(r._guide),t&&t()):Aero.model.guide.byId(e,function(e){r._guide=e,Aero.view.step.render(r._guide),aeroStorage.setItem("aero:session",JSON.stringify(r._guide),function(){t&&t()},!0)})},!0)},setStep:function(e,t,o){this._current=parseInt(e),t?o&&o():aeroStorage.setItem("aero:session:current",this._current,function(){o&&o()},!0)},redirect:function(e,t,o){var r=this,i=!1,s=document.URL,a=aeroStorage.override?Aero.host:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"");if("/#/"==e&&(i=!0),e||(e=""),e=(o||a)+e,o||(e=e.replace(Aero.host,location.protocol+"//"+location.host)),i||(/#$/.test(s)&&(s=s.replace("#","")),/\/$/.test(s)&&(s=s.slice(0,-1))),e=AeroStep.getSubURL(e),"all"==t)return!1;if("par"==t&&(s=s.split("?")[0],e=e.split("?")[0]),"anc"==t&&(s=s.split("#")[0],e=e.split("#")[0]),s!=e){var n=aeroStorage.getItem("aero:session:404"),p=n?parseInt(n)+1:0;if(aeroStorage.setItem("aero:session:404",p),p>1)Aero.confirm({ok:AeroStep.lang.done,title:AeroStep.lang.notfound,msg:AeroStep.lang.urlloop+"</br></br><strong>"+e+"</strong>",onConfirm:function(){Aero.tip.stop()},onClose:function(){Aero.view.step.setState(aeroStorage.getItem("aero:session:pause"),"forward")}});else{if(Aero.forceTakeme||Aero.navigating||0==Aero.tip._current)return Aero.navigating=!1,window.location=e,!0;Aero.confirm({ok:AeroStep.lang.oopst,cancel:AeroStep.lang.oopsm,title:AeroStep.lang.oops,msg:AeroStep.lang.oopsdesc,onConfirm:function(){window.location=e},onCancel:function(){Aero.forceTakeme=!0;var e=Aero.tip._current-1;r.setStep(e,!1,function(){Aero.tip.jumpTo(e)})},onClose:function(){Aero.view.step.setState(aeroStorage.getItem("aero:session:pause"),"forward")}})}return!0}return!1},validate:function(){var e=!0,t=Aero.step.get(this._current);return t.answers&&t.answers.length>0&&(e=Aero.view.quiz.validate(t)),e},start:function(e,t,o){var r=t||0,i=this;aeroStorage.getItem("aero:session:cds",function(t){t?Aero.host=t:aeroStorage.setItem("aero:session:cds",Aero.host,function(){},!0),i._forward=!0,i.setGuide(e,function(){i.setNav(),i.beforeShow(r),Aero.audit.init(function(){i.setNav(),$q(".aero-restrict").remove(),i.beforeShow(r)})},o)},!0)},stop:function(){var e=this;e.validate()&&(Aero.audit.save(),aeroStorage.getItem("aero:session:cds",function(t){t&&(Aero.host=AeroStep.host,aeroStorage.removeItem("aero:sidebar:cdshost",!0),aeroStorage.removeItem("aero:session:cds",!0),aeroStorage.removeItem("aero:guides",null),aeroStorage.removeItem("aero:cache",null)),$q(".aero-play").remove(),aeroStorage.setItem("aero:cache",-1);e.isReturnBranch()||(Aero.view.step.record&&Aero.view.step.record.off(),Aero.tip._guide.step&&Aero.tip._current==Aero.tip._guide.step.length-1&&e.sayCongrats(),e.setStep(null),e.hide(e._current),clearInterval(e.ob),AeroStep.session.destroy(),Aero.tip._guide=null,Aero.guide.init())},!0))},next:function(){if(this.validate())if("1"!=aeroStorage.getItem("aero:session:end")){var e=Aero.step.get(this._current);this._forward=!0,clearInterval(this.ob),aeroStorage.removeItem("aero:session:pause"),-1!=e.next&&(this.hide(this._current),this.beforeShow(e.next))}else AeroStep.admin||self.stop()},prev:function(){var e=Aero.step.get(this._current);this._forward=!1,clearInterval(this.ob),aeroStorage.removeItem("aero:session:pause"),-1!=e.prev&&(this.hide(this._current),this.beforeShow(e.prev))},jumpTo:function(e){if("1"==aeroStorage.getItem("aero:session:end"))AeroStep.admin?aeroStorage.removeItem("aero:session:end"):self.stop();else{var t=Aero.step.get(e);this._forward=!0,clearInterval(this.ob),Aero.jump=!0,$q(".aero-play").remove(),aeroStorage.removeItem("aero:session:pause"),t&&(this.hide(this._current),this.beforeShow(e))}},findStep:function(e){var t=!1;return"orphan"==e.position&&(e.loc="body"),e.loc&&(0!==(t=e.isFrame?$q(e.framePath).contents().find(e.loc):$q(e.loc)).length&&t.is(":visible")&&"hidden"!=t.css("visibility")||(t=!1)),t},findStepTimeout:function(type,step,time,i){var self=this;if(!(Aero.hashChange||(clearTimeout(Aero.timeFindStep),$q(".aero-modal:visible").length>0)))if(self.tries<2*time)Aero.timeFindStep=setTimeout(function(){self.hide(i-1);var before=self._forward?step.beforeCode:self._guide.step[i].beforeCode;if(before)try{eval(before)}catch(e){Aero.log("Before show code is broken: "+e,"error")}self.show(i),self.tries++},500);else{Aero.view.step.setState(i,"missing");var prefix="loss"==type?"loss":"";if("alert"==step[type])this.renderException(step[prefix+"alert"],step[prefix+"alertContent"],!0);else if("back"==step[type])Aero.view.step.setState(i,"missing"),this.prev();else if("skip"==step[type])self.next();else if("skipto"==step[type]){self.jumpTo(step[prefix+"skipto"]);for(var i=Aero.tip._current;i<=step[prefix+"skipto"]-1;i++)Aero.view.step.setState(i,"missing")}else{if("ignore"==step[type])return;this.renderException("Step is Missing","To fix this, try:<ul style='font-size:14px'><li>Using a more generic element</li><li>Increase the step wait timer</li><li>Check the previous step navigation:<ul><li>Page changed or refreshed - when steps move between pages</li><li>Next item visible - on the same page, but has an animation or time delay when showing the next step</li></ul></li></ul>",!0)}}},observe:function(e,t,o){var r=this,i=Aero.step.get(e);t?(clearInterval(r.obf),r.obf=setInterval(function(){var e=r.findStep(i);Aero.navigating=!0,Aero.log("Observing for item visible","info"),e&&(Aero.log("Observe found item","success"),clearInterval(r.obf),o())},500)):(clearInterval(r.ob),r.ob=setInterval(function(){Aero.log("Observing for item not visible","info");r.findStep(i)||setTimeout(function(){if(Aero.navigating)return Aero.navigating=!1,void clearInterval(r.ob);Aero.log("Observe lost item","warn"),o(),clearInterval(r.ob)},500)},1e3))},beforeShow:function(i){var self=this;self.tries=1;var step=Aero.step.get(i);self.setStep(i,!1,function(){var wait=200,before=self._forward?step.beforeCode:self._guide.step[i].beforeCode;if(step.pause&&(wait=1e3*parseInt(step.pause)),before)try{eval(before)}catch(e){Aero.log("Before show code is broken: "+e,"error")}clearTimeout(Aero.timeBeforeShow),Aero.timeBeforeShow=setTimeout(function(){Aero.hashChange||self.show(i)},wait)})},show:function(i,skipStore){var $tip,$el,step,self;self=this,clearTimeout(Aero.timeFindStep),0!=Aero.tip._guide.step.length&&(void 0===i&&(i=self._current),!Aero.tip._guide||i>Aero.tip._guide.step.length||i<0||(aeroStorage.setItem("aero:session:forward",!0),step=Aero.step.get(i),aeroStorage.setItem("aero:sidebar:open",step.sidebar?0:1,function(){},!0),self.setStep(i,skipStore,function(){if(step.sidebar?setTimeout("Aero.view.sidebar.hide();",100):aeroStorage.getItem("aero:sidebar:open",function(e){$q(".aero-sidebar").hasClass("open")||"1"!=e||Aero.view.sidebar.show()},!0),$el=self.findStep(step,i),AeroStep.admin&&aeroStorage.getItem("aero:session:pause")&&aeroStorage.getItem("aero:session:forwardUrl")!==document.URL){Aero.view.step.setState(aeroStorage.getItem("aero:session:pause"),"forward");var $play=$q('<a class="aero-play aero-play-icon"><span></span></a>'),$overlay=$q('<div class="aero-play aero-play-shadow"></div>');return $play.css({top:$q(window).height()/2-150,left:$q(window).width()/2-100}),$overlay.css({opacity:.4}),$q("body").append($play,$overlay),void(Aero.view.step.record&&aeroStorage.getItem("aero:session:recording")&&Aero.view.step.record.on(!0))}if(!self.redirect(step.url,step.noUrl,step.cds)){if(aeroStorage.removeItem("aero:session:404"),$el&&$el.is(":visible")){Aero.log("Found Step "+i,"success"),Aero.navigating=!1,Aero.tip.isMoving=null,self.observe(i,!1,function(){self.findStepTimeout("loss",step,0,i)}),step.mask&&""!=step.mask&&$el.mask(step.mask),Aero.audit.update(),AeroStep.admin&&(aeroStorage.setItem("aero:sidebar:cdshost",i+"~"+window.location.host,function(){},!0),aeroStorage.setItem("aero:session:pause",i),aeroStorage.setItem("aero:session:forwardUrl",document.URL)),$tip=$q(self.options.template(step)),step.branch&&($tip=self.renderBranch($tip,step.branch,step.branchstep,step.return)),$tip=self.buildNav($tip,step),$q(".ae-active-el").removeClass("ae-active-el"),$el.addClass("ae-active-el"),$q("body").append($tip),Aero.view.step.setState(i);try{step.onCode&&eval(step.onCode)}catch(e){Aero.log("On show code error: "+e,"error")}step.spotlight&&self.spotlight($tip,step),self.setPosition($el,$tip,step.position),self.setEvents($el,step.nav,$tip,step.position),"orphan"!=step.position?self.scrollToElement($el):$q(".aero-tip").fadeIn(200)}else{if(step.tries&&step.tries>0)return void self.findStepTimeout("miss",step,step.tries,i);step.multi||(clearTimeout(Aero.timeFindStep),Aero.log("Skipping step: "+i+" with loc:"+step.loc,"error"),Aero.view.step.setState(i,"missing"),i<Aero.tip._guide.step.length&&(self._forward?self.next():self.prev()))}var d=self._forward?1:-1,isMulti=!1;(self._forward&&Aero.step.get(i+d).multi||!self._forward&&step.multi)&&(isMulti=!0),Aero.jump&&step.multi&&(isMulti=!0,d=-1,self._forward=!1),isMulti&&self.show(i+d,!0),Aero.jump=null}})))},hide:function(i){var step=Aero.step.get(i);if(!(!$q(".aero-tip:visible").length>0)){if(step.offCode)try{eval(step.offCode)}catch(e){Aero.log("Before hide code is broken: "+e,"error")}if($q(".aero-active, .aero-showElement").removeClass("aero-active aero-showElement aero-relativePosition"),$q(".aero-tip, .aero-remove").remove(),step.afterCode)try{eval(step.afterCode)}catch(e){Aero.log("After hide code is broken: "+e,"error")}}},buildNav:function(e,t){var o="",r=!1;return t.nav.next||t.nav.blur||(r=!0),0==t.nav.length&&(r=!1),t.noNav||(-1==t.next&&(o+="<a class='aero-btn-end'>"+this.options.labels.end+"</a>"),t.noNext||r||-1==t.next||(o+="<a class='aero-btn-next'>"+this.options.labels.next+"</a>"),t.noPrev||-1==t.prev||(o+="<a class='aero-btn-prev'>"+this.options.labels.prev+"</a>")),e.find(".aero-tip-nav").append(o),e},setPosition:function(e,t,o){var r={},i=e.offset(),s=t.outerWidth()/2,a=t.outerHeight(),n=i.left+e.outerWidth()/2,p=i.top+e.outerHeight()/2,l=t.find(".aero-tip-arrow");switch(r.tLeft=s-l.outerWidth()/2,r.tTop=t.outerHeight()/2-l.outerHeight()/2,o){case"top":r.left=n-s,r.top=i.top-a-t.find(".aero-tip-arrow").outerHeight();break;case"bottom":r.left=n-s,r.top=i.top+e.outerHeight();break;case"left":r.left=i.left-t.outerWidth()-t.find(".aero-tip-arrow").outerWidth(),r.top=p-a/2;break;case"right":r.left=i.left+e.outerWidth(),r.top=p-a/2;break;case"orphan":r.left=$q(window).width()/2-s,r.top=$q(window).height()/2-a/2}r=this.containIn(document,t,r,o),t.css({left:r.left,top:r.top}),(t.hasClass("aero-tip-bottom")||t.hasClass("aero-tip-top"))&&l.css({left:r.tLeft}),(t.hasClass("aero-tip-left")||t.hasClass("aero-tip-right"))&&l.css({top:r.tTop}),t.hasClass("aero-tip-top")&&l.css({top:"auto"})},containIn:function(e,t,o,r){var i=$q(e).height(),s=$q(window).width(),a=o.left+t.outerWidth()-s,n=o.top+t.outerHeight()-i;a>0&&("bottom"!=r&&"top"!=r||(o.tLeft+=a),o.left-=a),o.left<0&&("bottom"!=r&&"top"!=r||(o.tLeft+=o.left),o.left-=o.left),o.top<0&&("left"!=r&&"right"!=r||(o.tTop+=o.top),o.top-=o.top),n>0&&"bottom"==r&&("left"!=r&&"right"!=r||(o.tTop+=n),o.top-=n);return o.left+t.outerWidth()>s-270?aeroStorage.getItem("aero:sidebar:open",function(e){Aero.view.sidebar.hide()},!0):aeroStorage.getItem("aero:sidebar:open",function(e){"1"==e&&Aero.view.sidebar.show()},!0),o},scrollToElement:function(e){var t,o,r,i,s;(t=$q(".aero-tip:eq(0)")).show(),o=Aero.pos.isScrollable(e),e.visible(!1,o)&&t.visible(!1)?(t.hide(),$q(".aero-tip").fadeIn(200)):(i=o?o.height()/2:$q(window).height()/2,r=o?o.scrollTop()-o.offset().top:0,o=o||$q("body, html"),s=r+t.offset().top-i+t.outerHeight()/2,t.hide(),o.stop().animate({scrollTop:s},500,function(){$q(".aero-tip").fadeIn(200)}))},isReturnBranch:function(){var e=aeroStorage.getItem("aero:session:branch:returnid"),t=aeroStorage.getItem("aero:session:branch:returnto");return!!e&&(t&&""!=t||(t=0),Aero.confirm({ok:"Return",cancel:"End Guide",title:"Branch complete",msg:"You have completed this branch, we will now move you back to the original guide.",onConfirm:function(){Aero.audit.save(),Aero.tip.hide(),Aero.tip.start(e,parseInt(t),!0),aeroStorage.removeItem("aero:session:branch:returnid"),aeroStorage.removeItem("aero:session:branch:returnto")},onCancel:function(){aeroStorage.removeItem("aero:session:branch:returnid"),Aero.tip.stop()}}),!0)},renderBranch:function(e,t,o,r){var s=e.find(".aero-tip-body").html()+"<div class='aero-branch'></div>";return setTimeout(function(){for(i in t)"string"==typeof t[i]&&Aero.guide.get(t[i],function(e){0==$q(".aero-branch").find("#b-"+e.id).length&&$q(".aero-branch").append("<a id='b-"+e.id+"' data-returnid='"+Aero.tip._guide.id+"' data-returnto='"+r+"' data-guideid='"+e.id+"' class='aero-start'>"+e.title+"</a>"),$q(window).trigger("resize")})},250),e.find(".aero-tip-body").html(s),e},renderException:function(e,t,o){var r="";if(o&&AeroStep.admin){r='<div class="aero-section aero-goto"><label>Go back to step:</label><select id="aero-goto">';for(var i=0;i<Aero.tip._guide.step.length;i++){r+="<option "+(i==Aero.tip._current-1?'selected="selected"':"")+'value="'+i+'">'+(i+1)+": "+Aero.tip._guide.step[i].title+"</option>"}r+="</select></div>"}Aero.confirm({ok:"End Guide",cancel:o?"Go Back":"Ok",title:e,msg:t+r,onConfirm:function(){Aero.tip.stop()},onCancel:function(){o&&AeroStep.admin?Aero.tip.jumpTo(parseInt($q("#aero-goto").val())):o&&Aero.tip.prev()},onClose:function(){Aero.view.step.setState(aeroStorage.getItem("aero:session:pause"),"forward")}})},setNav:function(){var e=this;$q("body").off("mousedown.aPe").on("mousedown.aPe",".aero-btn-prev",function(){return Aero.navigating=!0,e.prev(),!1}).off("click.aEd").on("click.aEd",".aero-btn-end",function(){e.stop()})},sayCongrats:function(){aeroStorage.getItem("aero:session",function(e){var t=JSON.parse(e);AeroStep.admin||Aero.confirm({ok:AeroStep.lang.ok,cancel:"",title:AeroStep.lang.gfinished,msg:AeroStep.lang.congrats+t.title,onConfirm:function(){AeroStep.session.destroy()}})},!0)},setEvents:function(e,t,o,r){var i=this;$q(document).off("scroll.scw").on("scroll.scw"+Aero.tip._current,function(){i.setPosition(e,o,r)},250),$q('div *:not(".aero-steps")').off("scroll.scd").on("scroll.scd"+Aero.tip._current,function(){i.setPosition(e,o,r)},250),$q(".aero-tip").draggable({handle:"div.aero-tip-draggable"}),$q("body").off("click.ctxx").on("click.ctxx",".aero-tip-title a",function(){Aero.tip.stop()}),$q(window).on("resize",function(){i.setPosition(e,o,r),Aero.view.sidebar.setScrollable()},250),aeroStorage.removeItem("aero:session:end"),parseInt($q(".aero-tip:last").attr("id").replace("astep-",""))==Aero.tip._guide.step.length-1&&aeroStorage.setItem("aero:session:end",1),$q("body").off("click.branchc").on("click.branchc",".aero-continue",function(){Aero.tip.next()}),$q("body").off("click.branchs").on("click.branchs",".aero-start",function(){aeroStorage.setItem("aero:session:branch:returnid",$q(this).data("returnid")),aeroStorage.setItem("aero:session:branch:returnto",$q(this).data("returnto")),aeroStorage.setItem("aero:session:branch:audit",1),Aero.tip.hide(),Aero.tip.start($q(this).data("guideid"),0,!0)}),$q("body").off("mousedown.aNe").on("mousedown.aNe",".aero-btn-next",function(){return Aero.navigating=!0,i.next(),!1});for(var s in t)if(t.hasOwnProperty(s))switch(-1==t[s]&&(t[s]=Aero.tip._current+1),t[s]=parseInt(t[s]),s){case"next":$q("body").off("mousedown.aNe").on("mousedown.aNe",".aero-btn-next",function(){if(Aero.navigating=!0,i.validate())return i.jumpTo(t[s]),!1});break;case"click":e.off("click.aeronav").on("click.aeronav",e,function(){e.off("click.aeronav"),Aero.navigating=!0,i.validate()&&i.jumpTo(t[s])});break;case"rclick":e.off("contextmenu.aeronav").on("contextmenu.aeronav",e,function(){e.off("contextmenu.aeronav"),Aero.navigating=!0,i.validate()&&i.jumpTo(t[s])});break;case"mousedown":e.off("mousedown.aeronav").on("mousedown.aeronav",e,function(){Aero.navigating=!0,i.validate()&&i.jumpTo(t[s])});break;case"hover":e.off("mouseenter.aeronav").on("mouseenter.aeronav",e,function(){Aero.navigating=!0,i.validate()&&setTimeout(function(){i.jumpTo(t[s])},500)});break;case"blur":e.off("keydown.aeronav").on("keydown.aeronav",e,function(e){if(Aero.navigating=!0,i.validate()){var o=e.keyCode||e.which;13!=o&&9!=o||i.jumpTo(t[s])}}),e.off("focusout.aeronavb").on("focusout.aeronavb",e,function(e){Aero.navigating=!0,i.validate()&&i.jumpTo(t[s])});break;case"unload":$q(window).off("beforeunload.aeronav").on("beforeunload.aeronav",function(){Aero.navigating=!0,i.setStep(t[s])});break;case"observe":i.observe(i._current+1,!0,function(){Aero.navigating=!0,i.next()})}}};