"use strict";Aero.model.audit={key:"aero:session:audit",defaults:function(){return{user:Aero.constants.USERNAME,guideid:Aero.tip._guide.id,pathwayid:Aero.pathway.pathwayid,progress:1,perc:Math.round(1/Aero.tip._guide.step.length*100),timeStart:"",timeStamp:this.getTime(),timeTotal:""}},get:function(){return JSON.parse(aeroStorage.getItem(this.key))},update:function(e){if(!AeroStep.admin&&Aero.tip._guide){var t=JSON.parse(aeroStorage.getItem(this.key));t&&""!=t.id&&""==e.id&&(e.id=t.id),e.timeStamp=this.getTime(),aeroStorage.setItem(this.key,JSON.stringify(e))}},getTime:function(){var e=new Date;return e.getFullYear()+"-"+this.padZero(e.getMonth()+1)+"-"+this.padZero(e.getDate())+" "+this.padZero(e.getHours())+":"+this.padZero(e.getMinutes())+":"+this.padZero(e.getSeconds())},padZero:function(e){return("0"+e).slice(-2)}},Aero.view.audit={timeStart:0,timeTotal:0,setEvents:function(){this.startTimer(),$q(window).on("beforeunload",function(){Aero.audit.save()}),$q(window).on("focus.aerof",function(){Aero.view.audit.startTimer()}).on("blur.aerob",function(){Aero.view.audit.stopTimer()})},removeEvents:function(){$q(window).off("blur.aerob focus.aerof")},startTimer:function(){this.timeStart=(new Date).getTime()},stopTimer:function(){var e=(new Date).getTime();this.timeTotal=e-this.timeStart+this.timeTotal}},Aero.audit={enabled:!0,url:"api/audit",id:"",furthestStep:0,init:function(e){var t=!0;Aero.audit.furthestStep=0,Aero.view.audit.timeTotal=0,!AeroStep.admin&&Aero.constants.USERNAME&&void 0!==Aero.tip._guide&&Aero.tip._guide&&!aeroStorage.getItem("aero:session:audit")||(t=!1),aeroStorage.getItem("aero:session:branch:audit")&&(t=!0,aeroStorage.removeItem("aero:session:branch:audit")),Aero.view.audit.setEvents(),t?this.create(e):e()},create:function(e){if(!AeroStep.admin){var t=this,i=Aero.model.audit.defaults();i.timeStart=i.timeStamp,i.timeTotal=Aero.view.audit.timeTotal,Aero.send(this.url+"/create",{data:JSON.stringify(i)},function(o){t.id=o,i.id=o,Aero.model.audit.update(i),e&&e()},"GET")}},update:function(){if(!AeroStep.admin){var e=Aero.model.audit.get(),t=Aero.tip._current;t<this.furthestStep||(this.furthestStep=t,e.progress=t+1,e.perc=Math.round((t+1)/Aero.tip._guide.step.length*100),e.id=this.id,e.timeTotal=Aero.view.audit.timeTotal,Aero.model.audit.update(e))}},save:function(e){if(!AeroStep.admin&&Aero.tip._guide){var t=Aero.model.audit.get();t&&(Aero.view.audit.stopTimer(),t.timeTotal=Aero.view.audit.timeTotal,Aero.view.audit.removeEvents(),Aero.send(this.url+"/update",{data:JSON.stringify(t)},function(e){Aero.model.audit.update(t)},"GET")),e&&e()}}};