"use strict";!function(e){var t=(e.browser.msie?"paste":"input")+".mask",r=void 0!=window.orientation;e.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},dataName:"rawMaskFn"},e.fn.extend({caret:function(e,t){if(0!=this.length){if("number"==typeof e)return t="number"==typeof t?t:e,this.each(function(){if(this.setSelectionRange)this.setSelectionRange(e,t);else if(this.createTextRange){var r=this.createTextRange();r.collapse(!0),r.moveEnd("character",t),r.moveStart("character",e),r.select()}});if(this[0].setSelectionRange)e=this[0].selectionStart,t=this[0].selectionEnd;else if(document.selection&&document.selection.createRange){var r=document.selection.createRange();e=0-r.duplicate().moveStart("character",-1e5),t=e+r.text.length}return{begin:e,end:t}}},unmask:function(){return this.trigger("unmask")},mask:function(o,a){if(!o&&this.length>0){return e(this[0]).data(e.mask.dataName)()}a=e.extend({placeholder:"_",completed:null},a);var n=e.mask.definitions,i=[],s=o.length,c=null,u=o.length;return e.each(o.split(""),function(e,t){"?"==t?(u--,s=e):n[t]?(i.push(new RegExp(n[t])),null==c&&(c=i.length-1)):i.push(null)}),this.trigger("unmask").each(function(){function d(e){for(var t=g.val(),r=-1,o=0,n=0;o<u;o++)if(i[o]){for(h[o]=a.placeholder;n++<t.length;){var d=t.charAt(n-1);if(i[o].test(d)){h[o]=d,r=o;break}}if(n>t.length)break}else h[o]==t.charAt(n)&&o!=s&&(n++,r=o);return!e&&r+1<s?(g.val(""),p(0,u)):(e||r+1>=s)&&(l(),e||g.val(g.val().substring(0,r+1))),s?o:c}function l(){return g.val(h.join("")).val()}function p(e,t){for(var r=e;r<t&&r<u;r++)i[r]&&(h[r]=a.placeholder)}function f(e,t){if(!(e<0)){for(var r=e,o=m(t);r<u;r++)if(i[r]){if(!(o<u&&i[r].test(h[o])))break;h[r]=h[o],h[o]=a.placeholder,o=m(o)}l(),g.caret(Math.max(c,e))}}function m(e){for(;++e<=u&&!i[e];);return e}var g=e(this),h=e.map(o.split(""),function(e,t){if("?"!=e)return n[e]?a.placeholder:e}),v=g.val();g.data(e.mask.dataName,function(){return e.map(h,function(e,t){return i[t]&&e!=a.placeholder?e:null}).join("")}),g.attr("readonly")||g.one("unmask",function(){g.unbind(".mask").removeData(e.mask.dataName)}).bind("focus.mask",function(){v=g.val();var t=d();l();var r=function(){t==o.length?g.caret(0,t):g.caret(t)};(e.browser.msie?r:function(){setTimeout(r,0)})()}).bind("blur.mask",function(){d(),g.val()!=v&&g.change()}).bind("keydown.mask",function(e){var t=e.which;if(8==t||46==t||r&&127==t){var o=g.caret(),a=o.begin,n=o.end;return n-a==0&&(a=46!=t?function(e){for(;--e>=0&&!i[e];);return e}(a):n=m(a-1),n=46==t?m(n):n),p(a,n),f(a,n-1),!1}if(27==t)return g.val(v),g.caret(0,d()),!1}).bind("keypress.mask",function(e){var t=e.which,r=g.caret();if(e.ctrlKey||e.altKey||e.metaKey||t<32)return!0;if(t){r.end-r.begin!=0&&(p(r.begin,r.end),f(r.begin,r.end-1));var o=m(r.begin-1);if(o<u){var n=String.fromCharCode(t);if(i[o].test(n)){(function(e){for(var t=e,r=a.placeholder;t<u;t++)if(i[t]){var o=m(t),n=h[t];if(h[t]=r,!(o<u&&i[o].test(n)))break;r=n}})(o),h[o]=n,l();var s=m(o);g.caret(s),a.completed&&s>=u&&a.completed.call(g)}}return!1}}).bind(t,function(){setTimeout(function(){g.caret(d(!0))},0)}),d()})}})}($q),Aero.model.step={url:"api/steps",defaults:function(e){var t=e+1;return Aero.tip._guide.step&&(t=e===Aero.tip._guide.step.length-1?-1:e+1),{loc:"",tries:3,position:"bottom",id:"astep-"+e,next:t,prev:e-1}},update:function(e,t){aeroStorage.getItem("aero:session:index",function(r){var o=JSON.parse(aeroStorage.getItem("aero:guides"));o[r=parseInt(r)]=e,aeroStorage.setItem("aero:session:end",0),aeroStorage.setItem("aero:guides",JSON.stringify(o),function(){}),aeroStorage.setItem("aero:session",JSON.stringify(o[r]),function(){Aero.tip.setGuide(e.id,function(){Aero.tip._current==Aero.tip._guide.step.length&&Aero.tip._current--,Aero.tip._current||(Aero.tip._current=0),t||Aero.tip.jumpTo(Aero.tip._current)})},!0)},!0)},validate:function(){var e=$q("form").isFormValid();if(""==$q("#aeroEditor").trumbowyg("html").replace(/<br>/g,"")&&(e=!1,$q(".trumbowyg-editor").addClass("aero-require-error")),!e){$q("#aeroSection0 p:first").after('<div class="aero-error-box">'+AeroStep.lang.requirede+"</div>");var t=$q(".aero-require-error:eq(0)").parents(".aero-tab-content:eq(0)");t&&t.parent().find('a[href="#'+t.attr("id")+'"]').click()}return e}},Aero.view.step={render:function(e){var t=this;Aero.tpl.get("sidebar-steps.html",function(r){aeroStorage.getItem("aero:sidebar:open",function(o){aeroStorage.getItem("aero:session:tab",function(a){$q("#aeroStepbar").remove();var n=_q.template(r);$q("body").append(n({sidebar:o,g:e})),$q("#aeroGuidebar").remove(),a>$q("#aeroStepbar").outerHeight()&&(a=$q("#aeroStepbar").outerHeight()-100),a<0&&(a=0),$q("#aero-tab").css("top",a+"px"),t.setEvents(),Aero.view.sidebar.setScrollable()},!0)},!0)}),Aero.view.sidebar.setEvents()},renderShare:function(e){$q("body").append('<div class="aero-share-tip"><span></span><input type="text" value="'+e+'" /></div>'),$q(".aero-share-tip input").select()},setState:function(e,t){if(e||(e=Aero.tip._current),t)$q(".aero-steps li:eq("+e+")").attr("class","clearfix aero-"+t);else{var r=$q(".aero-steps li:eq("+e+")");r.addClass("aero-active"),r.removeClass("aero-forward aero-missing"),aeroStorage.removeItem("aero:session:forward",function(){},!0)}var o=$q("div.aero-steps"),a=$q("li.aero-active"),n=$q("div.aero-add-step"),i=0;a.length>0&&(n.length>0&&(i+=n.outerHeight()),o.animate({scrollTop:o.scrollTop()+a.position().top-o.height()/2+a.height()/2-i-$q(".aero-guide-title").outerHeight()}))},setEvents:function(){var e=this;AeroStep.admin&&$q("body").off("click.sa").on("click.sa",".aero-steps li > a",function(){Aero.tip.jumpTo($q(".aero-steps li").index($q(this).parent()))}),$q("body").off("click.aplay").on("click.aplay","a.aero-play-icon",function(){Aero.view.step.setState(parseInt(aeroStorage.getItem("aero:session:pause")),"non"),aeroStorage.removeItem("aero:session:pause"),Aero.tip.jumpTo(Aero.tip._current),$q(".aero-play").fadeOut(1e3,function(){$q(this).remove()})}),$q("body").off("click.sas").on("click.sas","a.aero-stop",function(){Aero.tip.stop()}),$q("body").off("click.ashare").on("click.ashare","a.aero-share",function(){return e.renderShare(Aero.host+$q(this).data("link")),!1}),$q(document).click(function(e){$q(e.target).hasClass("aero-share-tip")||$q(e.target).parent().hasClass("aero-share-tip")||$q(".aero-share-tip").remove()}),$q("#aero-tab").draggable({axis:"y",distance:10,containment:"body",stop:function(e,t){aeroStorage.setItem("aero:session:tab",t.offset.top,function(){},!0)}}),AeroStep.admin&&setTimeout("if(Aero.view.step.admin) Aero.view.step.admin.renderSortable();",100)}},Aero.step={get:function(e){try{var t=new Aero.model.step.defaults(e);return $q.extend({},t,Aero.tip._guide.step[e])}catch(e){AeroStep.session.destroy(),location.reload(!0)}},add:function(e,t,r){e.id=Aero.tip._guide.id,e.insertAt=Aero.tip._current?Aero.tip._current:0,Aero.send(Aero.model.step.url,e,function(e){0!=Aero.tip._guide.step.length&&Aero.tip._current++,Aero.model.step.update(e,r),t&&t(e)},"POST")},update:function(e,t,r){t.id=Aero.tip._guide.id,t.index=e,Aero.send(Aero.model.step.url,t,function(e){Aero.model.step.update(e),r&&r(e)},"PUT")},moveIndex:function(e,t){Aero.send(Aero.model.step.url+"/move",{id:Aero.tip._guide.id,from:e,to:t},function(e){Aero.model.step.update(e)},"PUT")},destroy:function(e,t){Aero.send(Aero.model.step.url,{id:Aero.tip._guide.id,index:e},function(e){Aero.model.step.update(e),t&&t(e)},"DELETE")}};