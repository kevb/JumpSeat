"use strict";Aero.model.guide={url:"api/guides",urlSearch:"api/search",defaults:function(){return{title:"",active:!1,steps:[]}},byId:function(e,t){Aero.guide.getAll(function(o){$q.each(o,function(a,r){r&&e==r.id&&(t(o[a]),aeroStorage.setItem("aero:session:index",a,function(){},!0))})})},update:function(e,t){Aero.guide.getAll(function(o){Aero.view.guide.render(o),e&&e(t)},!0)},validate:function(){var e=$q("form").isFormValid();return""==$q("#aeroEditor").trumbowyg("html").replace(/<br>/g,"")&&(e=!1,$q(".trumbowyg-editor").addClass("aero-require-error")),e||$q("#aeroSection0 p:first").after('<div class="aero-error-box">'+AeroStep.lang.requirede+"</div>"),e}},Aero.view.guide={render:function(e,t,o){var a=this;$q(".aero-restrict, .aero-contextual").remove(),o||a.clearSearch(),Aero.tpl.get("sidebar-guides.html",function(t){aeroStorage.getItem("aero:sidebar:open",function(o){aeroStorage.getItem("aero:session:tab",function(r){$q("#aeroGuidebar").remove();var i=_q.template(t);$q("body").append(i({sidebar:o,guides:e})),$q("#aeroStepbar").remove(),r>$q("#aeroGuidebar").outerHeight()&&(r=$q("#aeroGuidebar").outerHeight()-100),r<0&&(r=0),$q("#aero-tab").css("top",r+"px"),a.setEvents(),Aero.view.sidebar.setEvents(),Aero.view.sidebar.setScrollable();var n=parseInt($q("body").data("newguides"));n>0&&Aero.view.sidebar.notify(n)},!0)},!0)})},renderContextualTip:function(e,t){Aero.guide.get(e,function(o){!function(t,o){var a=$q(Aero.tip.options.template(t)),r=e+"-"+o;a.attr("id","atip-"+r),a.addClass("aero-action-tip"),$q("body").append(a),Aero.tip.setPosition($q("#aaction-"+r),$q("#atip-"+r),t.position),a.show()}(o.step[t],t)})},renderContextualAction:function(e){if(e.contextual&&0!=e.contextual.length)for(var t in e.contextual)if(e.step.length>0){var o=parseInt(e.contextual[t]);e.step[o]&&e.step[o].loc&&a(o,e.step[o].loc)}function a(t,o){var a,r;if((a=$q(o)).length>0){var i=a.offset();r=$q("<a />").attr("id","aaction-"+e.id+"-"+t).addClass("aero-contextual").css({top:i.top+a.outerHeight()/2-8,left:i.left+a.outerWidth()}).data("loc",o).data("guideid",e.id).data("step",parseInt(t)),$q("body").append(r)}}},renderRestrict:function(e){var t=this;if(!e.isComplete&&e.restrict&&0!=e.restrict.length)for(var o in e.restrict)o=parseInt(o.replace("s","")),e.step.length>0&&a(o,e.step[o].loc,e.step[o].restrictColor);function a(o,a,r){var i;$q(a).length>0&&(i=$q("<a />").addClass("aero-restrict").css({"background-color":r,cursor:"pointer",opacity:.5}).data("loc",a).data("guideid",e.id).data("step",parseInt(o)),$q("body").append(i),t.positionRestrict(i))}},positionRestrict:function(e){var t=$q(e.data("loc")),o=Aero.pos.isFixed(t)?"fixed":"absolute";e.css({width:t.outerWidth(),height:t.outerHeight(),top:t.offset().top,left:t.offset().left,position:o,"z-index":99999999})},search:function(e){var t=this;$q(".aero-search i").switchClass("fa-search","fa-times",0),$q(".aero-search a").switchClass("aero-search-btn","aero-search-clear",0),Aero.guide.getByTerm(e,function(o){o.search=e,t.render(o,function(){},!0)})},clearSearch:function(){$q(".aero-search-clear").length>0&&($q(".aero-search i").switchClass("fa-times","fa-search",0),$q(".aero-search a").switchClass("aero-search-clear","aero-search-btn",0),$q(".aero-search").removeClass("aero-active"),$q("input[name=aero_search]").val(AeroStep.lang.search))},setEvents:function(){var e=this;$q("body").off("click.aeroStart").on("click.aeroStart",".aero-guides ul li > a",function(){var e=$q(this).parents("li:eq(0)").data("guideid");aeroStorage.removeItem("aero:session:pause"),Aero.tip.start(e)}),$q("body").off("click.apF").on("focus.apF",".aero-sidebar input[name=aero_search]",function(){$q(this).parents("div:eq(0)").addClass("aero-active"),$q(this).val()==AeroStep.lang.search&&$q(this).val("")}),$q("body").off("click.apB").on("blur.apB",".aero-sidebar input[name=aero_search]",function(){""==$q(this).val()&&($q(this).parents("div:eq(0)").removeClass("aero-active"),$q(this).val(AeroStep.lang.search))}),$q("body").off("click.aS").on("click.aS",".aero-search a.aero-search-btn",function(){e.search($q("input[name=aero_search]").val())}),$q("body").off("keypress.asK").on("keypress.asK",".aero-sidebar input[name=aero_search]",function(t){13==(t.keyCode||t.which)&&e.search($q(this).val())}),$q("body").off("click.asC").on("click.asC",".aero-search-clear",function(){return Aero.guide.getAll(function(t){e.render(t)}),!1}),$q("body").off("click.asr").on("click.asr",".aero-restrict",function(){var e=$q(this);Aero.confirm({ok:AeroStep.lang.ok,title:AeroStep.lang.restrictt,msg:AeroStep.lang.restrictb,onConfirm:function(){Aero.tip.start(e.data("guideid"))}})}),$q("body").off("mouseenter.actip").on("mouseenter.actip",".aero-contextual",function(){var t=$q(this),o=t.data("guideid"),a=t.data("step");$q(".aero-action-tip").remove(),setTimeout(function(){e.renderContextualTip(o,a)},250)}),$q("body").off("mouseleave.actip").on("mouseleave.actip",".aero-contextual",function(){$q(".aero-action-tip").remove()}),$q("body").on("click",'input[name="aero_auto"]',function(){$q(".aero-auto-page").hide(),$q(this).is(":checked")&&$q(".aero-auto-page").show()})}},Aero.guide={init:function(){var e=this;Aero.tpl.get("sidebar-guides.html",function(){aeroStorage.getItem("aero:session:end")&&Aero.tip.sayCongrats(),e.getAll(function(e){aeroStorage.getItem("aero:session",function(t){var o=Aero.utils.getUrlParam("guideid");if(t){var a=JSON.parse(t);aeroStorage.getItem("aero:session:current",function(e){Aero.tip.start(a.id,parseInt(e))},!0)}else if(o)Aero.tip.start(Aero.utils.getUrlParam("guideid")),window.history.pushState("object or string","Title",window.location.href.replace("guideid","startedid"));else{var r=aeroStorage.getItem("aero:pathway");r&&"0"!=r?Aero.pathway.get(function(t){Aero.view.pathway.render(t,parseInt(r))||Aero.view.guide.render(e)}):Aero.view.guide.render(e)}},!0)})})},autoStart:function(e){if(Aero.view.guide.renderRestrict(e),Aero.view.guide.renderContextualAction(e),e.auto&&!e.isStarted&&!AeroStep.admin&&e.step.length>0){var t=!1;e.autoPage?t=!0:e.step.length>0&&window.location.pathname==e.step[0].url&&(t=!0),t&&(aeroStorage.setItem("aero:guide:auto",1),Aero.tip.start(e.id))}},updateCache:function(e){aeroStorage.setItem("aero:guides",JSON.stringify(e))},getAll:function(e,t){aeroStorage.getItem("aero:guide:auto")&&(t=!0,aeroStorage.removeItem("aero:guide:auto"));var o=null,a=aeroStorage.getItem("aero:guides"),r=aeroStorage.getItem("aero:cache"),i=aeroStorage.getItem("aero:locale");r||(r=AeroStep.cache),i||(r=AeroStep.locale),(r=parseInt(r))==AeroStep.cache&&i==AeroStep.locale||(o=JSON.parse(a),aeroStorage.removeItem("aero:guides"),a=null),!a||t?(Aero.log("Loading from SS","success"),Aero.send(Aero.model.guide.url,{enduser:Aero.constants.USERNAME},function(t){if(o){var a=t.length-o.length;a>0&&$q("body").data("newguides",a)}aeroStorage.setItem("aero:cache",AeroStep.cache),aeroStorage.setItem("aero:locale",AeroStep.locale),aeroStorage.setItem("aero:guides",JSON.stringify(t)),e&&e(t)})):(Aero.log("Loading from LS","success"),e(JSON.parse(a)))},get:function(e,t){Aero.send(Aero.model.guide.url,{id:e},function(e){t&&t(e)})},getByTerm:function(e,t){Aero.send(Aero.model.guide.urlSearch,{term:e},function(e){t&&t(e)})},create:function(e,t){Aero.send(Aero.model.guide.url,e,function(e){Aero.model.guide.update(t,e)},"POST")},update:function(e,t){Aero.send(Aero.model.guide.url,e,function(){Aero.model.guide.update(),t&&t()},"PUT")},destroy:function(e){Aero.send(Aero.model.guide.url,{id:e},function(){Aero.model.guide.update()},"DELETE")}},Aero.view.sidebar={setScrollable:function(){var e=$q(window).height()-($q(".aero-head").outerHeight()+$q(".aero-foot").outerHeight()),t=$q(".aero-guide-title").outerHeight(),o=$q(".aero-add-step").length>0?$q(".aero-add-step").outerHeight():0;$q(".aero-guides, .aero-steps").height(e-(t+o))},show:function(e,t){$q(".aero-sidebar").stop().animate({right:"-50px"},t,"easeInOutBack",function(){}).addClass("open"),e&&aeroStorage.setItem("aero:sidebar:open",1,function(){},!0)},hide:function(e){$q(".aero-sidebar").stop().animate({right:-$q(".aero-sidebar").outerWidth(!0)},300,"swing",function(){}).removeClass("open"),$q(".aero-admin-wrapper").length&&($q(".aero-admin-wrapper").remove(),$q("#aero-tab").css("left","-44px")),$q(".aero-blanket, .aero-edit-active").remove(),e&&aeroStorage.setItem("aero:sidebar:open",0,function(){},!0)},notify:function(){$q("#aero-tab").prepend('<span class="aero-not">'+$q("body").data("newguides")+"</span>")},setEvents:function(){var e,t=this;window.onresize=function(){clearTimeout(e),e=setTimeout(function(){t.setScrollable();var e=$q(".aero-restrict");0!=e.length&&e.each(function(){Aero.view.guide.positionRestrict($q(this))})},100)},$q("body").off("click.atc").on("click.atc","#aero-tab a",function(){$q(".aero-sidebar").hasClass("open")?t.hide(!0):t.show(!0)}),$q("#aero-tab").draggable({axis:"y",distance:10,containment:"body",stop:function(e,t){aeroStorage.setItem("aero:session:tab",t.offset.top,function(){},!0)}}),$q(window).off("hashchange.hashn").on("hashchange.hashn",function(){Aero.hashChange=!0,AeroStep.ready(function(){setTimeout(function(){Aero.hashChange=!1,Aero.guide.init()},500)},AeroStep.required)})}};